{% extends "base.html" %}

{% block title %}Fetching Posts - Facebook Analytics{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">Fetching Posts from Facebook</h4>
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                
                <h5 id="progressMessage">Starting post fetch...</h5>
                
                <div class="progress mb-4" style="height: 20px;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <span id="progressText">0%</span>
                    </div>
                </div>
                
                <div id="completionMessage" style="display: none;">
                    <div class="alert alert-success">
                        <h5>Fetch Completed!</h5>
                        <p id="completionDetails"></p>
                    </div>
                    <a href="{{ url_for('index') }}" class="btn btn-primary">View Posts</a>
                </div>
                
                <div id="errorMessage" class="alert alert-danger" style="display: none;">
                    <h5>Error</h5>
                    <p id="errorDetails"></p>
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">Go Back</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressMessage = document.getElementById('progressMessage');
    const completionMessage = document.getElementById('completionMessage');
    const completionDetails = document.getElementById('completionDetails');
    const errorMessage = document.getElementById('errorMessage');
    const errorDetails = document.getElementById('errorDetails');
    
    // Connect to the Server-Sent Events endpoint
    const eventSource = new EventSource("{{ url_for('fetch_posts_with_progress') }}");
    
    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        // Update progress
        progressBar.style.width = data.progress + '%';
        progressBar.setAttribute('aria-valuenow', data.progress);
        progressText.textContent = Math.round(data.progress) + '%';
        progressMessage.textContent = data.message;
    };
    
    eventSource.addEventListener('close', function() {
        // Close the connection
        eventSource.close();
        
        // Show completion message
        completionMessage.style.display = 'block';
        completionDetails.textContent = progressMessage.textContent;
        
        // Hide progress elements
        progressBar.style.display = 'none';
        progressMessage.style.display = 'none';
    });
    
    eventSource.onerror = function() {
        // Handle errors
        eventSource.close();
        errorMessage.style.display = 'block';
        errorDetails.textContent = 'An error occurred while fetching posts.';
    };
});
</script>
{% endblock %}